#!/usr/bin/env python3
"""
üîç Script de Debug - KidsAdvisor API
Debug espec√≠fico de cada componente da aplica√ß√£o
"""

import asyncio
import sys
import os
from datetime import datetime, timedelta

# Adicionar o diret√≥rio raiz ao path
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

class Debugger:
    def __init__(self):
        self.results = []
    
    def log(self, message: str, status: str = "INFO"):
        """Log com cores"""
        colors = {
            "SUCCESS": '\033[0;32m',
            "ERROR": '\033[0;31m',
            "WARNING": '\033[1;33m',
            "INFO": '\033[0;34m',
            "NC": '\033[0m'
        }
        
        timestamp = datetime.now().strftime("%H:%M:%S")
        color = colors.get(status, colors["INFO"])
        print(f"{color}üîç [{timestamp}] {message}{colors['NC']}")
    
    async def debug_database(self):
        """Debug da conex√£o MongoDB"""
        self.log("=== DEBUG: CONEX√ÉO MONGODB ===", "INFO")
        
        try:
            from app.database import connect_to_mongo, get_database, close_mongo_connection
            
            # Testar conex√£o
            self.log("Testando conex√£o com MongoDB...")
            await connect_to_mongo()
            db = get_database()
            
            # Testar opera√ß√µes b√°sicas
            self.log("Testando opera√ß√µes b√°sicas...")
            
            # Inserir documento de teste
            test_doc = {
                "test": "debug",
                "timestamp": datetime.utcnow(),
                "data": {"debug": True}
            }
            
            result = await db.debug_test.insert_one(test_doc)
            self.log(f"‚úÖ Inser√ß√£o OK: {result.inserted_id}", "SUCCESS")
            
            # Buscar documento
            doc = await db.debug_test.find_one({"_id": result.inserted_id})
            if doc:
                self.log(f"‚úÖ Busca OK: {doc['test']}", "SUCCESS")
            else:
                self.log("‚ùå Busca falhou", "ERROR")
            
            # Contar documentos
            count = await db.debug_test.count_documents({})
            self.log(f"‚úÖ Contagem OK: {count} documentos", "SUCCESS")
            
            # Limpar teste
            await db.debug_test.delete_one({"_id": result.inserted_id})
            self.log("‚úÖ Limpeza OK", "SUCCESS")
            
            # Verificar dados existentes
            users_count = await db.usuarios.count_documents({})
            events_count = await db.eventos.count_documents({})
            
            self.log(f"üìä Dados existentes:", "INFO")
            self.log(f"   üë• Usu√°rios: {users_count}", "INFO")
            self.log(f"   üé™ Eventos: {events_count}", "INFO")
            
            await close_mongo_connection()
            self.log("‚úÖ Conex√£o MongoDB OK", "SUCCESS")
            return True
            
        except Exception as e:
            self.log(f"‚ùå Erro na conex√£o MongoDB: {str(e)}", "ERROR")
            return False
    
    async def debug_auth(self):
        """Debug do sistema de autentica√ß√£o"""
        self.log("=== DEBUG: SISTEMA DE AUTENTICA√á√ÉO ===", "INFO")
        
        try:
            from app.auth import (
                get_password_hash, 
                verify_password, 
                create_access_token,
                authenticate_user
            )
            from app.database import connect_to_mongo, get_database
            
            # Testar hash de senha
            self.log("Testando hash de senha...")
            password = "teste123"
            hashed = get_password_hash(password)
            self.log(f"‚úÖ Hash gerado: {hashed[:30]}...", "SUCCESS")
            
            # Testar verifica√ß√£o
            is_valid = verify_password(password, hashed)
            if is_valid:
                self.log("‚úÖ Verifica√ß√£o de senha OK", "SUCCESS")
            else:
                self.log("‚ùå Verifica√ß√£o de senha falhou", "ERROR")
            
            # Testar token JWT
            self.log("Testando cria√ß√£o de token JWT...")
            token = create_access_token(
                {"sub": "test_user"}, 
                timedelta(minutes=30)
            )
            self.log(f"‚úÖ Token gerado: {token[:50]}...", "SUCCESS")
            
            # Testar decodifica√ß√£o
            from jose import jwt
            payload = jwt.decode(
                token, 
                "your-super-secret-key-change-in-production", 
                algorithms=["HS256"]
            )
            self.log(f"‚úÖ Token decodificado: {payload}", "SUCCESS")
            
            # Testar autentica√ß√£o com usu√°rio real
            self.log("Testando autentica√ß√£o com usu√°rio real...")
            await connect_to_mongo()
            db = get_database()
            
            # Buscar usu√°rio de exemplo
            user = await db.usuarios.find_one({"email": "maria@gmail.com"})
            if user:
                auth_result = await authenticate_user("maria@gmail.com", "123456")
                if auth_result:
                    self.log("‚úÖ Autentica√ß√£o com usu√°rio real OK", "SUCCESS")
                else:
                    self.log("‚ùå Autentica√ß√£o com usu√°rio real falhou", "ERROR")
            else:
                self.log("‚ö†Ô∏è Usu√°rio de exemplo n√£o encontrado", "WARNING")
            
            self.log("‚úÖ Sistema de autentica√ß√£o OK", "SUCCESS")
            return True
            
        except Exception as e:
            self.log(f"‚ùå Erro no sistema de autentica√ß√£o: {str(e)}", "ERROR")
            return False
    
    async def debug_recommendations(self):
        """Debug do sistema de recomenda√ß√µes"""
        self.log("=== DEBUG: SISTEMA DE RECOMENDA√á√ïES ===", "INFO")
        
        try:
            from app.services.recomendacao import RecomendacaoService
            from app.database import connect_to_mongo, get_database
            
            await connect_to_mongo()
            db = get_database()
            
            # Obter usu√°rio de teste
            user = await db.usuarios.find_one({"email": "maria@gmail.com"})
            if not user:
                self.log("‚ùå Usu√°rio de teste n√£o encontrado", "ERROR")
                return False
            
            self.log(f"üë§ Usu√°rio: {user['nome']}", "INFO")
            self.log(f"üìù Eventos curtidos: {len(user.get('eventosCurtidos', []))}", "INFO")
            self.log(f"üë• Amigos: {len(user.get('amigos', []))}", "INFO")
            
            # Obter todos os eventos
            eventos = []
            async for evento in db.eventos.find():
                eventos.append(evento)
            
            self.log(f"üé™ Total de eventos: {len(eventos)}", "INFO")
            
            # Testar servi√ßo de recomenda√ß√µes
            service = RecomendacaoService()
            
            # Testar recomenda√ß√µes de conte√∫do
            self.log("Testando recomenda√ß√µes baseadas em conte√∫do...")
            try:
                content_recs = await service._recomendacoes_por_conteudo(user, eventos)
                self.log(f"‚úÖ Recomenda√ß√µes de conte√∫do: {len(content_recs)}", "SUCCESS")
                
                for i, rec in enumerate(content_recs[:3]):
                    self.log(f"   {i+1}. Score: {rec['score']:.3f}")
                    
            except Exception as e:
                self.log(f"‚ùå Erro em recomenda√ß√µes de conte√∫do: {str(e)}", "ERROR")
            
            # Testar recomenda√ß√µes colaborativas
            self.log("Testando recomenda√ß√µes colaborativas...")
            try:
                collab_recs = await service._recomendacoes_colaborativas(user, eventos)
                self.log(f"‚úÖ Recomenda√ß√µes colaborativas: {len(collab_recs)}", "SUCCESS")
                
                for i, rec in enumerate(collab_recs[:3]):
                    self.log(f"   {i+1}. Score: {rec['score']:.3f}")
                    
            except Exception as e:
                self.log(f"‚ùå Erro em recomenda√ß√µes colaborativas: {str(e)}", "ERROR")
            
            # Testar recomenda√ß√µes h√≠bridas
            self.log("Testando recomenda√ß√µes h√≠bridas...")
            try:
                hybrid_recs = await service.obter_recomendacoes_hibridas(str(user["_id"]), 5)
                self.log(f"‚úÖ Recomenda√ß√µes h√≠bridas: {len(hybrid_recs)}", "SUCCESS")
                
                for i, rec in enumerate(hybrid_recs[:3]):
                    evento_nome = rec.evento.nome
                    score = rec.score
                    tipo = rec.tipo
                    self.log(f"   {i+1}. {evento_nome} (Score: {score:.3f}, Tipo: {tipo})")
                    
            except Exception as e:
                self.log(f"‚ùå Erro em recomenda√ß√µes h√≠bridas: {str(e)}", "ERROR")
            
            self.log("‚úÖ Sistema de recomenda√ß√µes OK", "SUCCESS")
            return True
            
        except Exception as e:
            self.log(f"‚ùå Erro no sistema de recomenda√ß√µes: {str(e)}", "ERROR")
            return False
    
    async def debug_gamification(self):
        """Debug do sistema de gamifica√ß√£o"""
        self.log("=== DEBUG: SISTEMA DE GAMIFICA√á√ÉO ===", "INFO")
        
        try:
            from app.services.gamificacao import GamificacaoService
            from app.database import connect_to_mongo, get_database
            
            await connect_to_mongo()
            db = get_database()
            
            # Obter usu√°rio de teste
            user = await db.usuarios.find_one({"email": "joao@gmail.com"})
            if not user:
                self.log("‚ùå Usu√°rio de teste n√£o encontrado", "ERROR")
                return False
            
            self.log(f"üë§ Usu√°rio: {user['nome']}", "INFO")
            self.log(f"‚≠ê XP atual: {user.get('xp', 0)}", "INFO")
            self.log(f"üèÜ N√≠vel atual: {user.get('nivel', 1)}", "INFO")
            self.log(f"üéñÔ∏è Badges: {user.get('badges', [])}", "INFO")
            
            # Testar servi√ßo de gamifica√ß√£o
            service = GamificacaoService()
            
            # Testar c√°lculo de n√≠vel
            self.log("Testando c√°lculo de n√≠vel...")
            nivel = await service.calcular_nivel(user.get('xp', 0))
            self.log(f"‚úÖ N√≠vel calculado: {nivel}", "SUCCESS")
            
            # Testar pr√≥ximo n√≠vel
            prox_xp = await service.obter_proximo_nivel_xp(nivel)
            self.log(f"‚úÖ XP para pr√≥ximo n√≠vel: {prox_xp}", "SUCCESS")
            
            # Testar verifica√ß√£o de badges
            self.log("Testando verifica√ß√£o de badges...")
            novos_badges = await service.verificar_badges(str(user["_id"]))
            self.log(f"‚úÖ Novos badges: {novos_badges}", "SUCCESS")
            
            # Testar progresso completo
            self.log("Testando progresso completo...")
            progresso = await service.obter_progresso_usuario(str(user["_id"]))
            if progresso:
                self.log(f"‚úÖ Progresso: XP={progresso.xp}, N√≠vel={progresso.nivel}", "SUCCESS")
                self.log(f"   Badges: {progresso.badges}", "INFO")
                self.log(f"   Eventos curtidos: {progresso.eventos_curtidos}", "INFO")
            else:
                self.log("‚ùå Falha ao obter progresso", "ERROR")
            
            # Testar leaderboard
            self.log("Testando leaderboard...")
            leaderboard = await service.obter_leaderboard(5)
            self.log(f"‚úÖ Leaderboard: {len(leaderboard)} usu√°rios", "SUCCESS")
            
            for i, entry in enumerate(leaderboard[:3]):
                self.log(f"   {i+1}. {entry.nome} - {entry.xp} XP (N√≠vel {entry.nivel})")
            
            # Testar badges dispon√≠veis
            self.log("Testando badges dispon√≠veis...")
            badges_info = await service.obter_badges_disponiveis(str(user["_id"]))
            self.log(f"‚úÖ Badges dispon√≠veis: {len(badges_info)}", "SUCCESS")
            
            for badge in badges_info:
                status = "‚úÖ" if badge.conquistado else "‚è≥"
                self.log(f"   {status} {badge.nome}: {badge.descricao}")
            
            self.log("‚úÖ Sistema de gamifica√ß√£o OK", "SUCCESS")
            return True
            
        except Exception as e:
            self.log(f"‚ùå Erro no sistema de gamifica√ß√£o: {str(e)}", "ERROR")
            return False
    
    async def debug_api_endpoints(self):
        """Debug dos endpoints da API"""
        self.log("=== DEBUG: ENDPOINTS DA API ===", "INFO")
        
        try:
            import requests
            
            base_url = "http://localhost:8000"
            
            # Testar health check
            self.log("Testando health check...")
            response = requests.get(f"{base_url}/health", timeout=5)
            if response.status_code == 200:
                self.log("‚úÖ Health check OK", "SUCCESS")
            else:
                self.log(f"‚ùå Health check falhou: {response.status_code}", "ERROR")
            
            # Testar documenta√ß√£o
            self.log("Testando documenta√ß√£o...")
            response = requests.get(f"{base_url}/docs", timeout=5)
            if response.status_code == 200:
                self.log("‚úÖ Swagger UI OK", "SUCCESS")
            else:
                self.log(f"‚ùå Swagger UI falhou: {response.status_code}", "ERROR")
            
            # Testar endpoint raiz
            self.log("Testando endpoint raiz...")
            response = requests.get(f"{base_url}/", timeout=5)
            if response.status_code == 200:
                self.log("‚úÖ Endpoint raiz OK", "SUCCESS")
            else:
                self.log(f"‚ùå Endpoint raiz falhou: {response.status_code}", "ERROR")
            
            self.log("‚úÖ Endpoints da API OK", "SUCCESS")
            return True
            
        except Exception as e:
            self.log(f"‚ùå Erro nos endpoints da API: {str(e)}", "ERROR")
            return False
    
    async def run_full_debug(self):
        """Executa debug completo"""
        self.log("üöÄ Iniciando debug completo da KidsAdvisor API...", "INFO")
        
        debug_tasks = [
            ("Conex√£o MongoDB", self.debug_database),
            ("Sistema de Autentica√ß√£o", self.debug_auth),
            ("Sistema de Recomenda√ß√µes", self.debug_recommendations),
            ("Sistema de Gamifica√ß√£o", self.debug_gamification),
            ("Endpoints da API", self.debug_api_endpoints)
        ]
        
        results = {}
        
        for task_name, task_func in debug_tasks:
            self.log(f"\n{'='*60}", "INFO")
            self.log(f"üîç DEBUG: {task_name}", "INFO")
            self.log(f"{'='*60}", "INFO")
            
            try:
                result = await task_func()
                results[task_name] = result
            except Exception as e:
                self.log(f"‚ùå Erro inesperado em {task_name}: {str(e)}", "ERROR")
                results[task_name] = False
        
        # Resumo
        self.log(f"\n{'='*60}", "INFO")
        self.log("üìä RESUMO DO DEBUG", "INFO")
        self.log(f"{'='*60}", "INFO")
        
        total = len(results)
        passed = sum(1 for r in results.values() if r)
        failed = total - passed
        
        self.log(f"Total de componentes: {total}", "INFO")
        self.log(f"‚úÖ OK: {passed}", "SUCCESS" if passed > 0 else "INFO")
        self.log(f"‚ùå Falharam: {failed}", "ERROR" if failed > 0 else "INFO")
        
        self.log("\nüìã Detalhes:", "INFO")
        for task_name, result in results.items():
            status = "‚úÖ" if result else "‚ùå"
            self.log(f"  {status} {task_name}")
        
        if failed == 0:
            self.log("\nüéâ Todos os componentes est√£o funcionando corretamente!", "SUCCESS")
        else:
            self.log(f"\n‚ö†Ô∏è {failed} componente(s) com problemas", "WARNING")
        
        return results

async def main():
    """Fun√ß√£o principal"""
    print("üîç KidsAdvisor API - Debug Completo")
    print("="*50)
    
    debugger = Debugger()
    results = await debugger.run_full_debug()
    
    # C√≥digo de sa√≠da
    failed_count = sum(1 for r in results.values() if not r)
    sys.exit(1 if failed_count > 0 else 0)

if __name__ == "__main__":
    asyncio.run(main())

